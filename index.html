<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECrew Absensi Transwisata - Smart Login System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-shadow {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .running-text {
            animation: scroll 25s linear infinite;
            white-space: nowrap;
        }
        @keyframes scroll {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .hover-scale {
            transition: transform 0.2s ease;
        }
        .hover-scale:hover {
            transform: scale(1.02);
        }
        .table-row {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .table-row:hover {
            background-color: #f8fafc;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .editable-field {
            border: 1px solid #e2e8f0;
            padding: 8px 12px;
            border-radius: 6px;
            transition: all 0.2s;
            background: white;
        }
        .editable-field:hover {
            border-color: #cbd5e0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .editable-field:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .status-tepat-waktu {
            background-color: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }
        .status-terlambat {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
        .status-pulang-cepat {
            background-color: #fef3c7;
            color: #92400e;
            border: 1px solid #fed7aa;
        }
        .status-overtime {
            background-color: #dbeafe;
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }
        .status-tidak-hadir {
            background-color: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }
        .modal-overlay {
            backdrop-filter: blur(4px);
        }
        .search-highlight {
            background-color: #fef08a;
            padding: 1px 2px;
            border-radius: 2px;
        }
        .loading-spinner {
            border: 2px solid #f3f4f6;
            border-top: 2px solid #4f46e5;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .chart-container {
            position: relative;
            height: 300px;
        }
        .profile-picture-container {
            cursor: pointer;
        }
        .profile-picture {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        .news-content {
            white-space: pre-wrap;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Login Page -->
    <div id="loginPage" class="min-h-screen gradient-bg flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl card-shadow p-8 w-full max-w-md fade-in">
            <div class="text-center mb-8">
                <div class="bg-indigo-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-users text-indigo-600 text-3xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-800 mb-2">ECrew Absensi</h1>
                <p class="text-gray-600">Transwisata Prima Operations</p>
            </div>
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <div class="relative">
                        <i class="fas fa-envelope absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        <input type="email" id="loginEmail" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Masukkan email Anda" required>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <div class="relative">
                        <i class="fas fa-lock absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        <input type="password" id="loginPassword" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Masukkan password" required>
                    </div>
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-medium hover:bg-indigo-700 transition duration-200 hover-scale">
                    <i class="fas fa-sign-in-alt mr-2"></i>
                    <span id="loginButtonText">Masuk ke Sistem</span>
                </button>
            </form>
        </div>
    </div>

    <!-- User Dashboard -->
    <div id="userDashboard" class="hidden min-h-screen bg-gray-50">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center">
                        <div class="bg-blue-100 w-10 h-10 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-user text-blue-600 text-lg"></i>
                        </div>
                        <div>
                            <h1 class="text-xl font-semibold text-gray-800">Dashboard Karyawan</h1>
                            <p class="text-xs text-gray-500">Transwisata Prima Operations</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="hidden md:flex items-center space-x-4">
                            <div class="text-sm text-gray-600">
                                <i class="fas fa-clock mr-1"></i>
                                <span id="userCurrentTime"></span>
                            </div>
                            <div class="text-sm text-gray-600">
                                <i class="fas fa-calendar mr-1"></i>
                                <span id="userCurrentDate"></span>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div class="profile-picture-container" onclick="triggerProfilePictureUpload()">
                                <img id="userProfilePicture" src="https://placehold.co/40x40/dbeafe/1e40af?text=U" class="profile-picture" alt="Profile Picture">
                            </div>
                            <div class="hidden md:block">
                                <p class="text-sm font-medium text-gray-800" id="currentUserName">Karyawan</p>
                                <p class="text-xs text-gray-500" id="currentUserDivision">Division</p>
                            </div>
                        </div>
                        <button onclick="logout()" class="text-gray-500 hover:text-gray-700 transition duration-200 p-2 rounded-lg hover:bg-gray-100">
                            <i class="fas fa-sign-out-alt text-lg"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Running Text -->
        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-2 overflow-hidden">
            <div class="running-text text-sm font-medium">
                ðŸ‘‹ Selamat datang di ECrew Absensi - Kelola kehadiran Anda dengan mudah dan efisien ðŸ‘‹
            </div>
        </div>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Quick Actions -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-xl card-shadow p-6 hover-scale">
                    <div class="flex items-center">
                        <div class="bg-green-100 w-12 h-12 rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-clock text-green-600 text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">Clock In</h3>
                            <p class="text-gray-600 text-sm">Absen masuk kerja</p>
                            <button onclick="openClockInModal()" class="mt-2 bg-green-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-700 transition duration-200 cursor-pointer">
                                <i class="fas fa-play mr-1"></i>Masuk
                            </button>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl card-shadow p-6 hover-scale">
                    <div class="flex items-center">
                        <div class="bg-red-100 w-12 h-12 rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-stop text-red-600 text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">Clock Out</h3>
                            <p class="text-gray-600 text-sm">Absen pulang kerja</p>
                            <button onclick="openClockOutModal()" id="clockOutBtn" class="mt-2 bg-red-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-red-700 transition duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed cursor-pointer">
                                <i class="fas fa-stop mr-1"></i>Pulang
                            </button>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl card-shadow p-6 hover-scale">
                    <div class="flex items-center">
                        <div class="bg-blue-100 w-12 h-12 rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-calendar-check text-blue-600 text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800" id="userTotalHadir">0</h3>
                            <p class="text-gray-600 text-sm">Hari hadir bulan ini</p>
                            <p class="text-xs text-blue-600 mt-1">
                                <i class="fas fa-chart-line mr-1"></i>Tracking otomatis
                            </p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl card-shadow p-6 hover-scale">
                    <div class="flex items-center">
                        <div class="bg-yellow-100 w-12 h-12 rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-hourglass-half text-yellow-600 text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800" id="userTotalJam">0j 0m</h3>
                            <p class="text-gray-600 text-sm">Total jam kerja</p>
                            <p class="text-xs text-yellow-600 mt-1">
                                <i class="fas fa-clock mr-1"></i>Bulan ini
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Company News & Updates -->
            <div class="bg-white rounded-xl card-shadow p-6 mb-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-6">
                    <i class="fas fa-newspaper mr-2 text-indigo-600"></i>
                    Berita & Update Terbaru
                </h2>
                <div class="space-y-4" id="companyNews">
                    <!-- News items will be populated by JavaScript -->
                </div>
                <div class="mt-6 text-center">
                    <button onclick="viewAllNews()" class="text-indigo-600 hover:text-indigo-800 text-sm font-medium">
                        Lihat Semua Berita <i class="fas fa-arrow-right ml-1"></i>
                    </button>
                </div>
            </div>

            <!-- Today's Status -->
            <div class="bg-white rounded-xl card-shadow p-6 mb-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-6">
                    <i class="fas fa-calendar-day mr-2 text-blue-600"></i>
                    Status Hari Ini
                </h2>
                <div id="todayStatus" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>

            <!-- Recent Attendance -->
            <div class="bg-white rounded-xl card-shadow p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-semibold text-gray-800">
                        <i class="fas fa-history mr-2 text-indigo-600"></i>
                        Riwayat Absensi Terbaru
                    </h2>
                    <button onclick="viewAllAttendance()" class="text-indigo-600 hover:text-indigo-800 text-sm font-medium">
                        Lihat Semua <i class="fas fa-arrow-right ml-1"></i>
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b-2 border-gray-200 bg-gray-50">
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Tanggal</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Jam Masuk</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Jam Pulang</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Total Kerja</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Status</th>
                            </tr>
                        </thead>
                        <tbody id="userAttendanceTable">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="hidden min-h-screen bg-gray-50">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center">
                        <div class="bg-indigo-100 w-10 h-10 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-user-shield text-indigo-600 text-lg"></i>
                        </div>
                        <div>
                            <h1 class="text-xl font-semibold text-gray-800">Admin Dashboard</h1>
                            <p class="text-xs text-gray-500">Transwisata Prima Operations</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="hidden md:flex items-center space-x-4">
                            <div class="text-sm text-gray-600">
                                <i class="fas fa-clock mr-1"></i>
                                <span id="currentTime"></span>
                            </div>
                            <div class="text-sm text-gray-600">
                                <i class="fas fa-calendar mr-1"></i>
                                <span id="currentDate"></span>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div class="bg-red-100 w-10 h-10 rounded-full flex items-center justify-center">
                                <i class="fas fa-user-shield text-red-600"></i>
                            </div>
                            <div class="hidden md:block">
                                <p class="text-sm font-medium text-gray-800">Administrator</p>
                                <p class="text-xs text-gray-500">Super Admin</p>
                            </div>
                        </div>
                        <button onclick="logout()" class="text-gray-500 hover:text-gray-700 transition duration-200 p-2 rounded-lg hover:bg-gray-100">
                            <i class="fas fa-sign-out-alt text-lg"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Running Text -->
        <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-2 overflow-hidden">
            <div class="running-text text-sm font-medium">
                ðŸ”§ Admin Dashboard - Kelola Data Absensi Seluruh Karyawan Transwisata | Real-time Analytics & Comprehensive Management System ðŸ”§
            </div>
        </div>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Statistics Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-xl card-shadow p-6 hover-scale">
                    <div class="flex items-center">
                        <div class="bg-green-100 w-12 h-12 rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-users text-green-600 text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-gray-800" id="totalKaryawan">0</h3>
                            <p class="text-gray-600 text-sm">Total Karyawan</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl card-shadow p-6 hover-scale">
                    <div class="flex items-center">
                        <div class="bg-blue-100 w-12 h-12 rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-check-circle text-blue-600 text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-gray-800" id="hadirHariIni">0</h3>
                            <p class="text-gray-600 text-sm">Hadir Hari Ini</p>
                            <p class="text-xs text-blue-600 mt-1">
                                <i class="fas fa-percentage mr-1"></i><span id="persentaseHadir">0%</span> kehadiran
                            </p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl card-shadow p-6 hover-scale">
                    <div class="flex items-center">
                        <div class="bg-yellow-100 w-12 h-12 rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-clock text-yellow-600 text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-gray-800" id="terlambatHariIni">0</h3>
                            <p class="text-gray-600 text-sm">Terlambat Hari Ini</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl card-shadow p-6 hover-scale">
                    <div class="flex items-center">
                        <div class="bg-red-100 w-12 h-12 rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-times-circle text-red-600 text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-gray-800" id="tidakHadirHariIni">0</h3>
                            <p class="text-gray-600 text-sm">Tidak Hadir</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="bg-white rounded-xl card-shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">
                        <i class="fas fa-chart-line mr-2 text-indigo-600"></i>
                        Trend Kehadiran Mingguan
                    </h3>
                    <div class="chart-container">
                        <canvas id="weeklyChart"></canvas>
                    </div>
                </div>
                <div class="bg-white rounded-xl card-shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">
                        <i class="fas fa-chart-pie mr-2 text-purple-600"></i>
                        Distribusi Status Kehadiran
                    </h3>
                    <div class="chart-container">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Advanced Filter Section -->
            <div class="bg-white rounded-xl card-shadow p-6 mb-8">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-semibold text-gray-800">
                        <i class="fas fa-filter mr-2 text-indigo-600"></i>
                        Filter & Pencarian Lanjutan
                    </h2>
                    <div class="flex items-center space-x-2">
                        <div class="loading-spinner hidden" id="filterLoading"></div>
                        <span class="text-sm text-gray-500" id="filterStatus">Siap untuk filter</span>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-user mr-1"></i>Nama Karyawan
                        </label>
                        <select id="filterNama" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" onchange="applyFilters()">
                            <option value="">Semua Karyawan</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-building mr-1"></i>Divisi
                        </label>
                        <select id="filterDivisi" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" onchange="applyFilters()">
                            <option value="">Semua Divisi</option>
                            <option value="Operation">Operation</option>
                            <option value="Maintenance">Maintenance</option>
                            <option value="Safety">Safety</option>
                            <option value="Staf">Staf</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-calendar mr-1"></i>Periode
                        </label>
                        <select id="filterPeriode" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" onchange="handlePeriodeChange()">
                            <option value="hari">Hari Ini</option>
                            <option value="minggu">Minggu Ini</option>
                            <option value="bulan">Bulan Ini</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-info-circle mr-1"></i>Status
                        </label>
                        <select id="filterStatus" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" onchange="applyFilters()">
                            <option value="">Semua Status</option>
                            <option value="Tepat Waktu">Tepat Waktu</option>
                            <option value="Terlambat">Terlambat</option>
                            <option value="Pulang Cepat">Pulang Cepat</option>
                            <option value="Overtime">Overtime</option>
                            <option value="Tidak Hadir">Tidak Hadir</option>
                        </select>
                    </div>
                </div>

                <!-- Custom Date Range (Hidden by default) -->
                <div id="customDateRange" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-calendar-alt mr-1"></i>Tanggal Mulai
                        </label>
                        <input type="date" id="filterTanggalMulai" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" onchange="applyFilters()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-calendar-alt mr-1"></i>Tanggal Akhir
                        </label>
                        <input type="date" id="filterTanggalAkhir" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" onchange="applyFilters()">
                    </div>
                </div>

                <!-- Search Bar -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-search mr-1"></i>Pencarian Global
                    </label>
                    <div class="relative">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        <input type="text" id="globalSearch" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Cari nama, email, divisi, atau keterangan..." oninput="applyFilters()">
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-wrap gap-4">
                    <button onclick="applyFilters()" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition duration-200 flex items-center">
                        <i class="fas fa-filter mr-2"></i>Terapkan Filter
                    </button>
                    <button onclick="resetFilters()" class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700 transition duration-200 flex items-center">
                        <i class="fas fa-refresh mr-2"></i>Reset Filter
                    </button>
                    <button onclick="exportData()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition duration-200 flex items-center">
                        <i class="fas fa-download mr-2"></i>Export Excel
                    </button>
                    <button onclick="addNewRecord()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition duration-200 flex items-center">
                        <i class="fas fa-plus mr-2"></i>Tambah Data
                    </button>
                    <button onclick="openAddNewsModal()" class="bg-teal-600 text-white px-6 py-2 rounded-lg hover:bg-teal-700 transition duration-200 flex items-center">
                        <i class="fas fa-newspaper mr-2"></i>Tambah Berita
                    </button>
                    <button onclick="bulkActions()" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition duration-200 flex items-center">
                        <i class="fas fa-tasks mr-2"></i>Bulk Actions
                    </button>
                </div>
            </div>

            <!-- Attendance Table -->
            <div class="bg-white rounded-xl card-shadow p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-semibold text-gray-800">
                        <i class="fas fa-table mr-2 text-indigo-600"></i>
                        Rekap Absensi Karyawan
                    </h2>
                    <div class="flex items-center space-x-4">
                        <div class="text-sm text-gray-600">
                            Total: <span class="font-semibold text-indigo-600" id="totalRecords">0</span> record
                        </div>
                        <div class="flex items-center space-x-2">
                            <label class="text-sm text-gray-600">Show:</label>
                            <select id="itemsPerPageSelect" class="border border-gray-300 rounded px-2 py-1 text-sm" onchange="changeItemsPerPage()">
                                <option value="10">10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b-2 border-gray-200 bg-gray-50">
                                <th class="text-left py-4 px-4 font-semibold text-gray-700">
                                    <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" class="mr-2">
                                    No
                                </th>
                                <th class="text-left py-4 px-4 font-semibold text-gray-700 cursor-pointer hover:bg-gray-100" onclick="sortTable('nama')">
                                    <i class="fas fa-user mr-1"></i>Nama
                                    <i class="fas fa-sort text-xs ml-1"></i>
                                </th>
                                <th class="text-left py-4 px-4 font-semibold text-gray-700 cursor-pointer hover:bg-gray-100" onclick="sortTable('divisi')">
                                    <i class="fas fa-building mr-1"></i>Divisi
                                    <i class="fas fa-sort text-xs ml-1"></i>
                                </th>
                                <th class="text-left py-4 px-4 font-semibold text-gray-700 cursor-pointer hover:bg-gray-100" onclick="sortTable('tanggal')">
                                    <i class="fas fa-calendar mr-1"></i>Tanggal
                                    <i class="fas fa-sort text-xs ml-1"></i>
                                </th>
                                <th class="text-left py-4 px-4 font-semibold text-gray-700">
                                    <i class="fas fa-clock mr-1"></i>Jam Masuk
                                </th>
                                <th class="text-left py-4 px-4 font-semibold text-gray-700">
                                    <i class="fas fa-clock mr-1"></i>Jam Pulang
                                </th>
                                <th class="text-left py-4 px-4 font-semibold text-gray-700">
                                    <i class="fas fa-hourglass-half mr-1"></i>Total Kerja
                                </th>
                                <th class="text-left py-4 px-4 font-semibold text-gray-700 cursor-pointer hover:bg-gray-100" onclick="sortTable('status')">
                                    <i class="fas fa-info-circle mr-1"></i>Status
                                    <i class="fas fa-sort text-xs ml-1"></i>
                                </th>
                                <th class="text-left py-4 px-4 font-semibold text-gray-700">
                                    <i class="fas fa-cogs mr-1"></i>Aksi
                                </th>
                            </tr>
                        </thead>
                        <tbody id="attendanceTableBody">
                            <!-- Data will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <!-- Enhanced Pagination -->
                <div class="flex flex-col md:flex-row items-center justify-between mt-6 space-y-4 md:space-y-0">
                    <div class="text-sm text-gray-600">
                        Menampilkan <span class="font-semibold" id="showingStart">1</span> - 
                        <span class="font-semibold" id="showingEnd">10</span> dari 
                        <span class="font-semibold" id="totalData">0</span> data
                    </div>
                    <div class="flex items-center space-x-2">
                        <button onclick="goToPage(1)" id="firstBtn" class="px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fas fa-angle-double-left"></i>
                        </button>
                        <button onclick="previousPage()" id="prevBtn" class="px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <div id="pageNumbers" class="flex space-x-2">
                            <!-- Page numbers will be generated here -->
                        </div>
                        <button onclick="nextPage()" id="nextBtn" class="px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                        <button onclick="goToPage('last')" id="lastBtn" class="px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fas fa-angle-double-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Hidden file input for profile picture -->
    <input type="file" id="profilePictureInput" class="hidden" accept="image/*">

    <!-- Clock In Modal -->
    <div id="clockInModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-overlay flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-screen overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-semibold text-gray-800">
                    <i class="fas fa-clock mr-2 text-green-600"></i>
                    Absen Masuk
                </h3>
                <button onclick="closeClockInModal()" class="text-gray-500 hover:text-gray-700 p-2 rounded-lg hover:bg-gray-100">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="clockInForm" class="space-y-6">
                <!-- Personal Information -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-calendar mr-1"></i>Tanggal Masuk
                        </label>
                        <input type="date" id="clockInDate" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-user mr-1"></i>Nama
                        </label>
                        <input type="text" id="clockInName" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-envelope mr-1"></i>Email
                        </label>
                        <input type="email" id="clockInEmail" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-building mr-1"></i>Divisi
                        </label>
                        <input type="text" id="clockInDivision" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-briefcase mr-1"></i>Posisi
                        </label>
                        <input type="text" id="clockInPosition" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-tasks mr-1"></i>Bertugas Sebagai <span class="text-red-500">*</span>
                        </label>
                        <select id="clockInDutyAs" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" required>
                            <option value="">Pilih tugas...</option>
                            <option value="Director">Director</option>
                            <option value="Safety, Quality & Security Manager">Safety, Quality & Security Manager</option>
                            <option value="Operation Manager">Operation Manager</option>
                            <option value="Maintenance Manager">Maintenance Manager</option>
                            <option value="Chief Pilot Fixed Wing">Chief Pilot Fixed Wing</option>
                            <option value="Chief Pilot Rotary Wing">Chief Pilot Rotary Wing</option>
                            <option value="Chief Flight Support">Chief Flight Support</option>
                            <option value="Chief Inspector">Chief Inspector</option>
                            <option value="Chief Engineer">Chief Engineer</option>
                            <option value="Chief Finance, Accounting & Staf">Chief Finance, Accounting & Staf</option>
                            <option value="Chief Engineering">Chief Engineering</option>
                            <option value="Pilot in Command">Pilot in Command</option>
                            <option value="Second in Command">Second in Command</option>
                            <option value="Ground Instructor">Ground Instructor</option>
                            <option value="Flight Instructor">Flight Instructor</option>
                            <option value="Company Check Pilot">Company Check Pilot</option>
                            <option value="Engineer">Engineer</option>
                            <option value="Line Pilot">Line Pilot</option>
                            <option value="Cabin Service">Cabin Service</option>
                            <option value="Student">Student</option>
                            <option value="Flight Support">Flight Support</option>
                            <option value="Ground Support">Ground Support</option>
                            <option value="Technical Representative">Technical Representative</option>
                            <option value="Engineering">Engineering</option>
                            <option value="Staff">Staff</option>
                            <option value="Logistic">Logistic</option>
                            <option value="Aviation Security">Aviation Security</option>
                            <option value="Driver">Driver</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-cog mr-1"></i>Jenis Pekerjaan <span class="text-red-500">*</span>
                        </label>
                        <select id="clockInTypeOfWork" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" required>
                            <option value="">Pilih jenis pekerjaan...</option>
                            <option value="Office Hour">Office Hour</option>
                            <option value="Standby Flight">Standby Flight</option>
                            <option value="Standby on Call">Standby on Call</option>
                            <option value="Pos One Gate">Pos One Gate</option>
                            <option value="Day Off">Day Off</option>
                            <option value="Day Off 7 Consecutive Days for Pilot">Day Off 7 Consecutive Days for Pilot</option>
                            <option value="Flight Duty VIP">Flight Duty VIP</option>
                            <option value="Ferry Flight">Ferry Flight</option>
                            <option value="PPC Simulator">PPC Simulator</option>
                            <option value="PPC Aircraft">PPC Aircraft</option>
                            <option value="Test Flight">Test Flight</option>
                            <option value="Ground Run">Ground Run</option>
                            <option value="Recurrent Training">Recurrent Training</option>
                            <option value="Recency Flight">Recency Flight</option>
                            <option value="Meeting Out of Office">Meeting Out of Office</option>
                            <option value="Medical Examination">Medical Examination</option>
                            <option value="Annual Leave">Annual Leave</option>
                            <option value="Sick">Sick</option>
                            <option value="Technical Representative">Technical Representative</option>
                            <option value="Aviation Security">Aviation Security</option>
                            <option value="Over Time">Over Time</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-info-circle mr-1"></i>Status Absen
                        </label>
                        <input type="text" value="On Working" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100" readonly>
                    </div>
                </div>

                <!-- Photo Section -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-camera mr-1"></i>Foto Masuk <span class="text-red-500">*</span>
                    </label>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                        <div id="cameraPreview" class="hidden">
                            <video id="clockInVideo" class="w-full max-w-md mx-auto rounded-lg" autoplay></video>
                            <div class="mt-4 space-x-4">
                                <button type="button" onclick="captureClockInPhoto()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                                    <i class="fas fa-camera mr-2"></i>Ambil Foto
                                </button>
                                <button type="button" onclick="stopCamera()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">
                                    <i class="fas fa-stop mr-2"></i>Tutup Kamera
                                </button>
                            </div>
                        </div>
                        <div id="photoResult" class="hidden">
                            <img id="clockInPhotoPreview" class="w-full max-w-md mx-auto rounded-lg mb-4">
                            <button type="button" onclick="retakeClockInPhoto()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                                <i class="fas fa-redo mr-2"></i>Ambil Ulang
                            </button>
                        </div>
                        <div id="cameraButton" class="text-gray-500">
                            <i class="fas fa-camera text-4xl mb-4"></i>
                            <p class="text-lg font-medium">Ambil Foto Masuk</p>
                            <button type="button" onclick="startCamera()" class="mt-4 bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700">
                                <i class="fas fa-camera mr-2"></i>Buka Kamera
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Location Section -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-map-marker-alt mr-1"></i>Lokasi Masuk <span class="text-red-500">*</span>
                    </label>
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <input type="text" id="clockInLatitude" placeholder="Latitude" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100" readonly>
                            </div>
                            <div>
                                <input type="text" id="clockInLongitude" placeholder="Longitude" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100" readonly>
                            </div>
                        </div>
                        <div id="clockInMap" class="h-64 bg-gray-200 rounded-lg flex items-center justify-center">
                            <div class="text-center text-gray-500">
                                <i class="fas fa-map text-4xl mb-2"></i>
                                <p>Klik "Dapatkan Lokasi" untuk menampilkan peta</p>
                            </div>
                        </div>
                        <button type="button" onclick="getCurrentLocation('clockIn')" class="w-full bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700">
                            <i class="fas fa-crosshairs mr-2"></i>Dapatkan Lokasi Saat Ini
                        </button>
                        <!-- Radius Status -->
                        <div id="clockInRadiusStatus" class="hidden p-4 rounded-lg">
                            <div class="flex items-center">
                                <i id="clockInRadiusIcon" class="text-2xl mr-3"></i>
                                <div>
                                    <h4 id="clockInRadiusTitle" class="font-semibold"></h4>
                                    <p id="clockInRadiusMessage" class="text-sm"></p>
                                </div>
                            </div>
                        </div>
                        <!-- Outside Radius Reason -->
                        <div id="clockInOutsideReason" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-exclamation-triangle mr-1"></i>Alasan Berada di Luar Radius <span class="text-red-500">*</span>
                            </label>
                            <textarea id="clockInReasonText" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" rows="3" placeholder="Jelaskan alasan Anda berada di luar radius kantor..." required></textarea>
                        </div>
                    </div>
                </div>

                <!-- Attendance Time -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-clock mr-1"></i>Absen Masuk
                    </label>
                    <input type="text" id="clockInTime" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100" readonly>
                </div>

                <!-- Status Message -->
                <div id="clockInStatusMessage" class="p-4 rounded-lg">
                    <div class="flex items-center">
                        <i id="clockInStatusIcon" class="text-2xl mr-3"></i>
                        <div>
                            <h4 id="clockInStatusTitle" class="font-semibold"></h4>
                            <p id="clockInStatusText" class="text-sm"></p>
                        </div>
                    </div>
                </div>

                <!-- Late Reason -->
                <div id="clockInLateReason" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-clock mr-1"></i>Alasan Terlambat <span class="text-red-500">*</span>
                    </label>
                    <textarea id="clockInLateReasonText" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" rows="3" placeholder="Jelaskan alasan keterlambatan Anda..." required></textarea>
                </div>

                <!-- Submit Button -->
                <div class="flex justify-end space-x-4 pt-6 border-t border-gray-200">
                    <button type="button" onclick="closeClockInModal()" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition duration-200">
                        <i class="fas fa-times mr-2"></i>Batal
                    </button>
                    <button type="submit" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition duration-200">
                        <i class="fas fa-check mr-2"></i>Kirim Absen Masuk
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Clock Out Modal -->
    <div id="clockOutModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-overlay flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-screen overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-semibold text-gray-800">
                    <i class="fas fa-clock mr-2 text-red-600"></i>
                    Absen Pulang
                </h3>
                <button onclick="closeClockOutModal()" class="text-gray-500 hover:text-gray-700 p-2 rounded-lg hover:bg-gray-100">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="clockOutForm" class="space-y-6">
                <!-- Work Report Section -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-clipboard mr-1"></i>Remark Pekerjaan Hari Ini <span class="text-red-500">*</span>
                    </label>
                    <textarea id="clockOutWorkRemark" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" rows="4" placeholder="Jelaskan pekerjaan yang telah Anda lakukan hari ini..." required></textarea>
                </div>

                <!-- Work Photo Section -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-images mr-1"></i>Foto Pekerjaan Hari Ini <span class="text-red-500">*</span>
                    </label>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                        <div id="workPhotoResult" class="hidden">
                            <img id="clockOutWorkPhotoPreview" class="w-full max-w-md mx-auto rounded-lg mb-4">
                            <button type="button" onclick="retakeWorkPhoto()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                                <i class="fas fa-redo mr-2"></i>Pilih Ulang
                            </button>
                        </div>
                        <div id="workPhotoButton" class="text-gray-500">
                            <i class="fas fa-images text-4xl mb-4"></i>
                            <p class="text-lg font-medium">Pilih Foto Pekerjaan</p>
                            <input type="file" id="workPhotoInput" accept="image/*" class="hidden" onchange="handleWorkPhotoSelect(event)">
                            <button type="button" onclick="document.getElementById('workPhotoInput').click()" class="mt-4 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700">
                                <i class="fas fa-images mr-2"></i>Pilih dari Gallery
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Location Section -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-map-marker-alt mr-1"></i>Lokasi Pulang <span class="text-red-500">*</span>
                    </label>
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <input type="text" id="clockOutLatitude" placeholder="Latitude" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100" readonly>
                            </div>
                            <div>
                                <input type="text" id="clockOutLongitude" placeholder="Longitude" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100" readonly>
                            </div>
                        </div>
                        <div id="clockOutMap" class="h-64 bg-gray-200 rounded-lg flex items-center justify-center">
                            <div class="text-center text-gray-500">
                                <i class="fas fa-map text-4xl mb-2"></i>
                                <p>Klik "Dapatkan Lokasi" untuk menampilkan peta</p>
                            </div>
                        </div>
                        <button type="button" onclick="getCurrentLocation('clockOut')" class="w-full bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700">
                            <i class="fas fa-crosshairs mr-2"></i>Dapatkan Lokasi Saat Ini
                        </button>
                        <!-- Radius Status -->
                        <div id="clockOutRadiusStatus" class="hidden p-4 rounded-lg">
                            <div class="flex items-center">
                                <i id="clockOutRadiusIcon" class="text-2xl mr-3"></i>
                                <div>
                                    <h4 id="clockOutRadiusTitle" class="font-semibold"></h4>
                                    <p id="clockOutRadiusMessage" class="text-sm"></p>
                                </div>
                            </div>
                        </div>
                        <!-- Outside Radius Reason -->
                        <div id="clockOutOutsideReason" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-exclamation-triangle mr-1"></i>Alasan Berada di Luar Radius <span class="text-red-500">*</span>
                            </label>
                            <textarea id="clockOutReasonText" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" rows="3" placeholder="Jelaskan alasan Anda berada di luar radius kantor..." required></textarea>
                        </div>
                    </div>
                </div>

                <!-- Attendance Time -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-clock mr-1"></i>Absen Pulang
                    </label>
                    <input type="text" id="clockOutTime" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100" readonly>
                </div>

                <!-- Status Message -->
                <div id="clockOutStatusMessage" class="p-4 rounded-lg">
                    <div class="flex items-center">
                        <i id="clockOutStatusIcon" class="text-2xl mr-3"></i>
                        <div>
                            <h4 id="clockOutStatusTitle" class="font-semibold"></h4>
                            <p id="clockOutStatusText" class="text-sm"></p>
                        </div>
                    </div>
                </div>

                <!-- Overtime Display -->
                <div id="clockOutOvertime" class="hidden p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <div class="flex items-center">
                        <i class="fas fa-clock text-blue-600 text-2xl mr-3"></i>
                        <div>
                            <h4 class="font-semibold text-blue-800">Total Overtime</h4>
                            <p id="clockOutOvertimeText" class="text-blue-600"></p>
                        </div>
                    </div>
                </div>

                <!-- Total Work Time -->
                <div id="clockOutTotalWork" class="p-4 bg-green-50 border border-green-200 rounded-lg">
                    <div class="flex items-center">
                        <i class="fas fa-hourglass-half text-green-600 text-2xl mr-3"></i>
                        <div>
                            <h4 class="font-semibold text-green-800">Total Waktu Kerja</h4>
                            <p id="clockOutTotalWorkText" class="text-green-600"></p>
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="flex justify-end space-x-4 pt-6 border-t border-gray-200">
                    <button type="button" onclick="closeClockOutModal()" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition duration-200">
                        <i class="fas fa-times mr-2"></i>Batal
                    </button>
                    <button type="submit" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-200">
                        <i class="fas fa-check mr-2"></i>Kirim Absen Pulang
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Enhanced Detail Modal -->
    <div id="detailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-overlay flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-6xl w-full mx-4 max-h-screen overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-semibold text-gray-800">
                    <i class="fas fa-user-edit mr-2 text-indigo-600"></i>
                    Detail & Edit Absensi Karyawan
                </h3>
                <button onclick="closeDetailModal()" class="text-gray-500 hover:text-gray-700 p-2 rounded-lg hover:bg-gray-100">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="detailContent" class="space-y-6">
                <!-- Content will be populated by JavaScript -->
            </div>
            <div class="flex justify-between items-center mt-8 pt-6 border-t border-gray-200">
                <div class="text-sm text-gray-500">
                    <i class="fas fa-info-circle mr-1"></i>
                    Semua perubahan akan disimpan secara real-time
                </div>
                <div class="flex space-x-4">
                    <button onclick="closeDetailModal()" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition duration-200">
                        <i class="fas fa-times mr-2"></i>Tutup
                    </button>
                    <button onclick="saveChanges()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition duration-200">
                        <i class="fas fa-save mr-2"></i>Simpan Perubahan
                    </button>
                    <button onclick="deleteRecord()" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-200">
                        <i class="fas fa-trash mr-2"></i>Hapus Data
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- User Attendance Detail Modal -->
    <div id="userAttendanceDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-overlay flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-screen overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-semibold text-gray-800">
                    <i class="fas fa-info-circle mr-2 text-blue-600"></i>
                    Detail Riwayat Absensi
                </h3>
                <button onclick="closeUserAttendanceDetailModal()" class="text-gray-500 hover:text-gray-700 p-2 rounded-lg hover:bg-gray-100">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="userAttendanceDetailContent" class="space-y-4">
                <!-- Content will be populated by JavaScript -->
            </div>
            <div class="flex justify-end mt-6 pt-4 border-t border-gray-200">
                <button onclick="closeUserAttendanceDetailModal()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition duration-200">
                    Tutup
                </button>
            </div>
        </div>
    </div>
    
    <!-- Add News Modal -->
    <div id="addNewsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-overlay flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-screen overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-semibold text-gray-800">
                    <i class="fas fa-newspaper mr-2 text-teal-600"></i>
                    Tambah Berita Baru
                </h3>
                <button onclick="closeAddNewsModal()" class="text-gray-500 hover:text-gray-700 p-2 rounded-lg hover:bg-gray-100">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="addNewsForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Judul Berita</label>
                    <input type="text" id="newsTitle" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Konten</label>
                    <textarea id="newsContent" class="w-full px-4 py-2 border border-gray-300 rounded-lg" rows="6" required></textarea>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Kategori</label>
                        <input type="text" id="newsCategory" class="w-full px-4 py-2 border border-gray-300 rounded-lg" value="Umum" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Prioritas</label>
                        <select id="newsPriority" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Foto Berita (Opsional)</label>
                    <input type="file" id="newsPhoto" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" accept="image/*" onchange="previewNewsImage(event)">
                    <img id="newsImagePreview" class="hidden mt-4 rounded-lg max-h-48 w-auto mx-auto"/>
                </div>
                <div class="flex justify-end pt-4 border-t">
                    <button type="submit" class="px-6 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 transition">
                        <i class="fas fa-plus mr-2"></i>Tambah Berita
                    </button>
                </div>
            </form>
        </div>
    </div>


    <script>
    // =================================================================
    // GLOBAL STATE & SETUP
    // =================================================================
    let currentPage = 1;
    let itemsPerPage = 10;
    let filteredData = [];
    let allAttendanceData = [];
    let currentEditingRecord = null;
    let sortColumn = '';
    let sortDirection = 'asc';
    let selectedRecords = [];
    let currentUser = null;
    let userType = null;
    let weeklyChartInstance = null;
    let statusChartInstance = null;
    let currentStream = null;
    let clockInPhotoData = null;
    let workPhotoData = null;
    let todayClockInRecord = null;
    let newsPhotoData = null;

    const companyNews = [
        { id: 1, title: "Peningkatan Protokol Keselamatan Penerbangan", content: "Mulai bulan ini, Transwisata Prima Operations menerapkan protokol keselamatan baru...", date: "2024-07-15", category: "Safety", priority: "high", author: "Safety Dept" },
        { id: 2, title: "Update Sistem Absensi Digital", content: "Sistem ECrew Absensi telah diperbarui dengan fitur foto real-time dan tracking GPS...", date: "2024-07-12", category: "Technology", priority: "medium", author: "IT Dept" },
        { id: 3, title: "Program Pelatihan Pilot Berkelanjutan", content: "Transwisata meluncurkan program pelatihan berkelanjutan untuk semua pilot...", date: "2024-07-10", category: "Training", priority: "medium", author: "Training Dept" }
    ];

    const employeeData = {
        "Rustam Suhanda": { email: "managementtranswisata@gmail.com", division: "Staf", position: "President Director", password: "rustam", role: "USER" },
        "Selfy Warauw": { email: "warauw_1@yahoo.com", division: "Staf", position: "Director", password: "selfy", role: "USER" },
        "Muhamad Ramdani Masri": { email: "crunkbolcow@gmail.com", division: "Operation", position: "Chief Pilot Rotary Wing", password: "muhamad", role: "USER" },
        "Sulaksono Teddy Prabowo": { email: "fly5103@gmail.com", division: "Operation", position: "Line Pilot", password: "sulaksono", role: "USER" },
        "Marcelino Bhaharoenawanto": { email: "marcelino412ep@gmail.com", division: "Operation", position: "Line Pilot", password: "marcelino", role: "USER" },
        "Muhamad Sofwan": { email: "sofwanm819@gmail.com", division: "Operation", position: "Chief Pilot Fixed Wing", password: "muhamad", role: "USER" },
        "Sofian M. L. Tobing": { email: "sofiantobing692@gmail.com", division: "Operation", position: "General Manager", password: "sofian", role: "USER" },
        "Rico Febdiandana": { email: "ricofebdi@gmail.com", division: "Operation", position: "Chief Flight Support", password: "rico", role: "USER" },
        "Alfajri": { email: "alfajri_koto@yahoo.com", division: "Operation", position: "Line Pilot", password: "alfajri", role: "USER" },
        "Eli Setya": { email: "tioxpilot@gmail.com", division: "Operation", position: "Line Pilot", password: "eli", role: "USER" },
        "Susetyo Harijanto": { email: "harijantosusetyo@gmail.com", division: "Operation", position: "Operation Manager", password: "susetyo", role: "USER" },
        "Purwoko": { email: "purwoko.mulyono@yahoo.com", division: "Operation", position: "Line Pilot", password: "purwoko", role: "USER" },
        "Riza Hanindita": { email: "icul2122@gmail.com", division: "Operation", position: "Line Pilot", password: "riza", role: "USER" },
        "Henaldy Arifia Sudrajat": { email: "henaldy.ts204@gmail.com", division: "Operation", position: "Line Pilot", password: "henaldy", role: "USER" },
        "Kadek Amelia Nadya Berliana": { email: "amelberliana@yahoo.co.id", division: "Operation", position: "Line Pilot", password: "kadek", role: "USER" },
        "Qorry Maulidya Natawijaya": { email: "qnatawijaya@gmail.com", division: "Operation", position: "Cabin Service", password: "qorry", role: "USER" },
        "Shentira Anggia Putri": { email: "anggiashentira@gmail.com", division: "Operation", position: "Cabin Service", password: "shentira", role: "USER" },
        "Tiffani Pricilia Hasan": { email: "tiffanipriciliaaaa@gmail.com", division: "Operation", position: "Cabin Service", password: "tiffani", role: "USER" },
        "Agustin Zulfani Prihatini": { email: "agustinzulfani74@gmail.com", division: "Operation", position: "Cabin Service", password: "agustin", role: "USER" },
        "Nadya Casey Ivanka": { email: "ivankacasey99@gmail.com", division: "Operation", position: "Cabin Service", password: "nadya", role: "USER" },
        "Yanu Prihatno": { email: "prihatnoyanu@gmail.com", division: "Maintenance", position: "Engineer", password: "yanu", role: "USER" },
        "Bayu Nugroho": { email: "bayu.avicena@gmail.com", division: "Maintenance", position: "Engineer", password: "bayu", role: "USER" },
        "Wahyudi Suseno": { email: "nawawahyudisuseno090@gmail.com", division: "Maintenance", position: "Avionic", password: "wahyudi", role: "USER" },
        "Sigit Hardadi": { email: "sigithardadi88@yahoo.com", division: "Maintenance", position: "Engineer", password: "sigit", role: "USER" },
        "Hadi Sutrisno": { email: "hadikamilatun@gmail.com", division: "Maintenance", position: "Maintenance Manager", password: "hadi", role: "USER" },
        "Suhairi": { email: "suhairitwa@gmail.com", division: "Maintenance", position: "Engineer", password: "suhairi", role: "USER" },
        "Suyanto": { email: "yanto.umardin@gmail.com", division: "Maintenance", position: "Avionic", password: "suyanto", role: "USER" },
        "Lazarus Rio Raymond": { email: "rioraymond89@gmail.com", division: "Maintenance", position: "Engineer", password: "lazarus", role: "USER" },
        "Febie Aguti Effendi": { email: "mpiipie@gmail.com", division: "Maintenance", position: "Engineer", password: "febie", role: "USER" },
        "Diki Hariyanto": { email: "dikiatnu7@gmail.com", division: "Maintenance", position: "Chief Engineer", password: "diki", role: "USER" },
        "Prayit Susonggo": { email: "prayitsusonggo@yahoo.com", division: "Maintenance", position: "Avionic", password: "prayit", role: "USER" },
        "Iskandar Akbar Hakim": { email: "iskandarakbarhakim@gmail.com", division: "Maintenance", position: "Chief Inspector", password: "iskandar", role: "USER" },
        "Arif Vrybadi Halim": { email: "GlexXRSvpcgo@outlook.com", division: "Maintenance", position: "Engineer", password: "arif", role: "USER" },
        "Alfiza Eka Putra": { email: "alfizaekap@gmail.com", division: "Maintenance", position: "Engineer", password: "alfiza", role: "USER" },
        "Dedi Prasetyo": { email: "deditren99@gmail.com", division: "Safety", position: "Aviation Security", password: "dedi", role: "USER" },
        "Media H Marbun": { email: "mediamarbun@gmail.com", division: "Staf", position: "Human Resource Development", password: "media", role: "USER" },
        "Fatmawati": { email: "ulieumeda@gmail.com", division: "Staf", position: "Finance", password: "fatmawati", role: "USER" },
        "Dede Rahman Arafiq": { email: "d2rahman@yahoo.co.id", division: "Staf", position: "Finance", password: "dede", role: "USER" },
        "Leo Fitzgerald Sinay": { email: "leosinay@gmail.com", division: "Maintenance", position: "Chief Engineering", password: "leo", role: "USER" },
        "Khairul Zaman Pohan": { email: "pohan16zaman@gmail.com", division: "Operation", position: "Flight Support", password: "khairul", role: "USER" },
        "Sentot Basuki": { email: "sentotbasuki@gmail.com", division: "Operation", position: "Flight Support", password: "sentot", role: "USER" },
        "Bobby Feisal Mahardhika": { email: "bobby.feisal22@gmail.com", division: "Staf", position: "Engineering", password: "bobby", role: "USER" },
        "Tri Widayat": { email: "tri3wiwid@gmail.com", division: "Operation", position: "Flight Support", password: "tri", role: "USER" },
        "Isdarminto": { email: "is.darminto35@gmail.com", division: "Staf", position: "Logistic", password: "isdarminto", role: "USER" },
        "Sulaichan Noor Ali": { email: "sulaichann@gmail.com", division: "Staf", position: "Logistic", password: "sulaichan", role: "USER" },
        "Sri Muljono Bayu Putro": { email: "sbayuputro@gmail.com", division: "Operation", position: "Flight Support", password: "sri", role: "USER" },
        "Asri Gatot Yulianto": { email: "Asrigatot.67@gmail.com", division: "Safety", position: "Aviation Security", password: "asri", role: "USER" },
        "Nanang Chabibi": { email: "nanangchabibi3@gmail.com", division: "Safety", position: "Aviation Security", password: "nanang", role: "USER" },
        "Hariyanto": { email: "katellisna423@gmail.com", division: "Safety", position: "Aviation Security", password: "hariyanto", role: "USER" },
        "Supriyono": { email: "fardhan0509@gmail.com", division: "Staf", position: "Kurir", password: "supriyono", role: "USER" },
        "Kasna": { email: "kasna.pjln799@gmail.com", division: "Staf", position: "Driver", password: "kasna", role: "USER" },
        "Rizal Setiawan": { email: "rizalsetiawan020812@gmail.com", division: "Staf", position: "Driver", password: "rizal", role: "USER" },
        "Ardi Rizki": { email: "ardi.rizk91@gmail.com", division: "Maintenance", position: "Engineer", password: "ardi", role: "USER" },
        "Wawan Setiawan": { email: "setiawanwawan7312@gmail.com", division: "Operation", position: "Line Pilot", password: "wawan", role: "USER" },
        "Tommy Saputra": { email: "tommysaputra473@gmail.com", division: "Staf", position: "Chief Finance, Accounting & Tax", password: "tommy", role: "USER" },
        "Mochamad Riza": { email: "mch_riza@yahoo.com", division: "Safety", position: "Quality, Safety, Security Manager", password: "mochamad", role: "USER" },
        "Alexander Anggarda Yunan Devata": { email: "alexanderdevata@yahoo.co.id", division: "Operation", position: "Flight Support", password: "alexander", role: "USER" },
        "Sukyono": { email: "sskkyy020@gmail.com", division: "Operation", position: "Flight Support", password: "sukyono", role: "USER" }
    };

    const officeCoordinates = [
        { lat: -6.266439, lng: 106.897480 },
        { lat: -6.265146, lng: 106.885701 }
    ];
    const radiusLimit = 250; // meters

    // =================================================================
    // CORE HELPER FUNCTIONS
    // =================================================================
    function calculateWorkHours(jamMasuk, jamPulang) {
        if (!jamMasuk || !jamPulang) return '0j 0m';
        const masukTotal = parseInt(jamMasuk.split(':')[0]) * 60 + parseInt(jamMasuk.split(':')[1]);
        const pulangTotal = parseInt(jamPulang.split(':')[0]) * 60 + parseInt(jamPulang.split(':')[1]);
        if (pulangTotal <= masukTotal) return '0j 0m';
        const totalMinutes = pulangTotal - masukTotal;
        return `${Math.floor(totalMinutes / 60)}j ${totalMinutes % 60}m`;
    }

    function getAttendanceStatus(jamMasuk, jamPulang) {
        if (!jamMasuk) return 'Tidak Hadir';
        if (parseInt(jamMasuk.split(':')[0]) * 60 + parseInt(jamMasuk.split(':')[1]) > 9 * 60) return 'Terlambat';
        if (jamPulang) {
            const pulangTotal = parseInt(jamPulang.split(':')[0]) * 60 + parseInt(jamPulang.split(':')[1]);
            if (pulangTotal < 17 * 60) return 'Pulang Cepat';
            if (pulangTotal > 17 * 60 + 30) return 'Overtime';
        }
        return 'Tepat Waktu';
    }

    function calculateOvertime(jamPulang) {
        if (!jamPulang) return '0 jam 0 menit';
        const pulangTotal = parseInt(jamPulang.split(':')[0]) * 60 + parseInt(jamPulang.split(':')[1]);
        const batasNormal = 17 * 60 + 30;
        if (pulangTotal > batasNormal) {
            const overtimeMinutes = pulangTotal - batasNormal;
            return `${Math.floor(overtimeMinutes / 60)} jam ${overtimeMinutes % 60} menit`;
        }
        return '0 jam 0 menit';
    }
    
    function formatDate(dateStr) {
        if (!dateStr) return '';
        return new Date(dateStr).toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }
    
    function updateDateTime(isAdmin) {
        const now = new Date();
        const timeStr = now.toLocaleTimeString('id-ID');
        const dateStr = now.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        const timeEl = document.getElementById(isAdmin ? 'currentTime' : 'userCurrentTime');
        const dateEl = document.getElementById(isAdmin ? 'currentDate' : 'userCurrentDate');
        if(timeEl) timeEl.textContent = timeStr;
        if(dateEl) dateEl.textContent = dateStr;
    }

    // =================================================================
    // AUTHENTICATION & INITIALIZATION
    // =================================================================
    document.getElementById('loginForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;

        if (email === 'admin@twa.com' && password === 'admintwa021') {
            userType = 'admin';
            currentUser = { name: 'Administrator', email: email, division: 'Management', position: 'Super Admin' };
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('adminDashboard').classList.remove('hidden');
            initializeAdminDashboard();
            return;
        }

        const employee = Object.entries(employeeData).find(([name, data]) => data.email === email);
        if (employee && password.toLowerCase() === employee[1].password.toLowerCase()) {
            userType = 'user';
            currentUser = { name: employee[0], ...employee[1] };
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('userDashboard').classList.remove('hidden');
            initializeUserDashboard();
            return;
        }
        alert('âŒ Email atau password salah!');
    });

    function logout() {
        document.getElementById('adminDashboard').classList.add('hidden');
        document.getElementById('userDashboard').classList.add('hidden');
        document.getElementById('loginPage').classList.remove('hidden');
        document.getElementById('loginForm').reset();
        currentUser = null;
        userType = null;
    }

    function initializeUserDashboard() {
        document.getElementById('currentUserName').textContent = currentUser.name;
        document.getElementById('currentUserDivision').textContent = currentUser.division;
        updateUserUI();
        renderCompanyNews();
        updateDateTime(false);
        setInterval(() => updateDateTime(false), 1000);
        
        // Add event listener for profile picture upload
        document.getElementById('profilePictureInput').addEventListener('change', handleProfilePictureUpload);
    }

    function initializeAdminDashboard() {
        filteredData = [...allAttendanceData];
        populateEmployeeFilter();
        setDefaultDates();
        refreshAdminDashboard();
        updateDateTime(true);
        setInterval(() => updateDateTime(true), 1000);
        document.getElementById('addNewsForm').addEventListener('submit', handleAddNews);
    }
    
    function refreshAdminDashboard() {
        if (userType === 'admin' && !document.getElementById('adminDashboard').classList.contains('hidden')) {
            updateStatistics();
            applyFilters(); 
            initializeCharts();
        }
    }

    // =================================================================
    // USER DASHBOARD UI & PROFILE PICTURE
    // =================================================================
    function triggerProfilePictureUpload() {
        document.getElementById('profilePictureInput').click();
    }

    function handleProfilePictureUpload(event) {
        const file = event.target.files[0];
        if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const imageUrl = e.target.result;
                document.getElementById('userProfilePicture').src = imageUrl;
                // Optionally save to currentUser object for session persistence
                if (currentUser) {
                    currentUser.profilePicture = imageUrl;
                }
            };
            reader.readAsDataURL(file);
        }
    }
    
    function updateUserUI() {
        updateUserStatistics();
        renderUserTodayStatus();
        renderUserAttendanceTable();
        const today = new Date().toISOString().split('T')[0];
        const activeRecords = allAttendanceData.filter(record => 
            record.nama === currentUser.name && record.tanggal === today && record.statusAbsen === 'On Working'
        );
        const clockOutBtn = document.getElementById('clockOutBtn');
        clockOutBtn.disabled = activeRecords.length === 0;
        clockOutBtn.innerHTML = `<i class="fas fa-stop mr-1"></i>` + (activeRecords.length > 0 ? `Pulang (${activeRecords.length} sesi)` : 'Pulang');
    }

    function renderCompanyNews() {
        const newsContainer = document.getElementById('companyNews');
        newsContainer.innerHTML = companyNews.map(news => `
            <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition cursor-pointer" onclick="viewNewsDetail(${news.id})">
                ${news.photo ? `<img src="${news.photo}" alt="News Image" class="w-full h-40 object-cover rounded-md mb-4">` : ''}
                <h3 class="font-semibold text-gray-800">${news.title}</h3>
                <p class="text-gray-600 text-sm mt-2 news-content">${news.content}</p>
            </div>`).join('');
    }

    function viewNewsDetail(newsId) {
        const news = companyNews.find(n => n.id === newsId);
        if (news) alert(`ðŸ“° ${news.title}\n\n${news.content}`);
    }

    function updateUserStatistics() {
        const userAttendance = allAttendanceData.filter(r => r.nama === currentUser.name);
        const currentMonth = new Date().getMonth();
        const monthlyAttendance = userAttendance.filter(r => new Date(r.tanggal).getMonth() === currentMonth);
        document.getElementById('userTotalHadir').textContent = monthlyAttendance.length;
        const totalMinutes = monthlyAttendance.reduce((acc, r) => acc + (parseInt(r.totalKerja.split('j')[0]) * 60 + parseInt(r.totalKerja.split('j ')[1] || '0')), 0);
        document.getElementById('userTotalJam').textContent = `${Math.floor(totalMinutes / 60)}j ${totalMinutes % 60}m`;
    }

    function renderUserTodayStatus() {
        const today = new Date().toISOString().split('T')[0];
        const todayRecords = allAttendanceData.filter(r => r.nama === currentUser.name && r.tanggal === today);
        const statusContainer = document.getElementById('todayStatus');
        if (todayRecords.length === 0) {
            statusContainer.innerHTML = `<div class="bg-gray-50 border p-4 rounded-lg col-span-3"><h3 class="font-semibold">Belum Absen</h3><p class="text-sm">Silakan lakukan absen masuk.</p></div>`;
        } else {
            const lastRecord = todayRecords[todayRecords.length - 1];
            statusContainer.innerHTML = `
                <div class="bg-green-50 border p-4 rounded-lg"><h3 class="font-semibold">Absen Hari Ini</h3><p class="text-sm">${todayRecords.length} sesi absen.</p></div>
                <div class="bg-blue-50 border p-4 rounded-lg"><h3 class="font-semibold">Status Terkini</h3><p class="text-sm">${lastRecord.statusAbsen === 'On Working' ? 'Sedang Bekerja' : 'Sudah Pulang'}</p></div>
            `;
        }
    }

    function renderUserAttendanceTable() {
        const userAttendance = allAttendanceData.filter(r => r.nama === currentUser.name).slice(0, 5);
        const tbody = document.getElementById('userAttendanceTable');
        tbody.innerHTML = userAttendance.length === 0 ? `<tr><td colspan="5" class="text-center py-8">Belum ada riwayat.</td></tr>` : 
            userAttendance.map(r => `
                <tr class="table-row border-b hover:bg-gray-50" onclick="viewUserAttendanceDetail('${r.id}')">
                    <td class="py-3 px-4">${formatDate(r.tanggal)}</td>
                    <td class="py-3 px-4 font-mono">${r.jamMasuk}</td>
                    <td class="py-3 px-4 font-mono">${r.jamPulang || '-'}</td>
                    <td class="py-3 px-4 font-semibold">${r.totalKerja}</td>
                    <td class="py-3 px-4"><span class="status-badge ${getStatusClass(r.status)}">${r.status}</span></td>
                </tr>`).join('');
    }

    // =================================================================
    // ADMIN DASHBOARD UI & FILTERS
    // =================================================================
    function populateEmployeeFilter() {
        const filterNama = document.getElementById('filterNama');
        filterNama.innerHTML = '<option value="">Semua Karyawan</option>' + 
            Object.keys(employeeData).sort().map(name => `<option value="${name}">${name}</option>`).join('');
    }

    function setDefaultDates() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('filterTanggalMulai').value = today;
        document.getElementById('filterTanggalAkhir').value = today;
    }

    function handlePeriodeChange() {
        document.getElementById('customDateRange').classList.toggle('hidden', document.getElementById('filterPeriode').value !== 'custom');
        applyFilters();
    }

    function updateStatistics() {
        const today = new Date().toISOString().split('T')[0];
        const todayData = allAttendanceData.filter(r => r.tanggal === today);
        const totalKaryawan = Object.keys(employeeData).length;
        const hadirHariIni = new Set(todayData.map(r => r.nama)).size;
        const terlambatHariIni = todayData.filter(r => r.status === 'Terlambat').length;
        document.getElementById('totalKaryawan').textContent = totalKaryawan;
        document.getElementById('hadirHariIni').textContent = hadirHariIni;
        document.getElementById('terlambatHariIni').textContent = terlambatHariIni;
        document.getElementById('tidakHadirHariIni').textContent = totalKaryawan - hadirHariIni;
        document.getElementById('persentaseHadir').textContent = totalKaryawan > 0 ? `${Math.round((hadirHariIni / totalKaryawan) * 100)}%` : '0%';
    }

    function initializeCharts() {
        if (weeklyChartInstance) weeklyChartInstance.destroy();
        if (statusChartInstance) statusChartInstance.destroy();
        initWeeklyChart();
        initStatusChart();
    }

    function initWeeklyChart() {
        const ctx = document.getElementById('weeklyChart').getContext('2d');
        const labels = [...Array(7)].map((_, i) => {
            const d = new Date();
            d.setDate(d.getDate() - i);
            return d.toLocaleDateString('id-ID', { weekday: 'short' });
        }).reverse();
        const data = labels.map((_, i) => {
            const d = new Date();
            d.setDate(d.getDate() - (6 - i));
            const dateStr = d.toISOString().split('T')[0];
            return new Set(allAttendanceData.filter(r => r.tanggal === dateStr).map(r => r.nama)).size;
        });
        weeklyChartInstance = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets: [{ label: 'Kehadiran', data, borderColor: '#4f46e5', tension: 0.4, fill: true }] },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    function initStatusChart() {
        const ctx = document.getElementById('statusChart').getContext('2d');
        const statusCounts = allAttendanceData.reduce((acc, r) => { acc[r.status] = (acc[r.status] || 0) + 1; return acc; }, {});
        statusChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: { 
                labels: Object.keys(statusCounts), 
                datasets: [{ data: Object.values(statusCounts), backgroundColor: ['#10b981', '#ef4444', '#f59e0b', '#3b82f6', '#6b7280'] }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    function applyFilters() {
        const filters = {
            nama: document.getElementById('filterNama').value,
            divisi: document.getElementById('filterDivisi').value,
            status: document.getElementById('filterStatus').value,
            search: document.getElementById('globalSearch').value.toLowerCase()
        };
        filteredData = allAttendanceData.filter(r => 
            (!filters.nama || r.nama === filters.nama) &&
            (!filters.divisi || r.divisi === filters.divisi) &&
            (!filters.status || r.status === filters.status) &&
            (!filters.search || Object.values(r).some(val => String(val).toLowerCase().includes(filters.search)))
        );
        currentPage = 1;
        renderTable();
    }

    function resetFilters() {
        document.getElementById('filterNama').value = '';
        document.getElementById('filterDivisi').value = '';
        document.getElementById('filterStatus').value = '';
        document.getElementById('globalSearch').value = '';
        applyFilters();
    }

    function renderTable() {
        const tbody = document.getElementById('attendanceTableBody');
        const startIndex = (currentPage - 1) * itemsPerPage;
        const pageData = filteredData.slice(startIndex, startIndex + itemsPerPage);
        tbody.innerHTML = pageData.length === 0 ? `<tr><td colspan="9" class="text-center py-8">Tidak ada data.</td></tr>` : 
            pageData.map((r, i) => `
                <tr class="table-row border-b" onclick="viewDetail('${r.id}')">
                    <td class="py-3 px-4"><input type="checkbox" value="${r.id}" onclick="event.stopPropagation();updateSelectedRecords()">${startIndex + i + 1}</td>
                    <td class="py-3 px-4 font-medium">${r.nama}</td>
                    <td class="py-3 px-4">${r.divisi}</td>
                    <td class="py-3 px-4">${formatDate(r.tanggal)}</td>
                    <td class="py-3 px-4 font-mono">${r.jamMasuk || '-'}</td>
                    <td class="py-3 px-4 font-mono">${r.jamPulang || '-'}</td>
                    <td class="py-3 px-4 font-semibold">${r.totalKerja}</td>
                    <td class="py-3 px-4"><span class="status-badge ${getStatusClass(r.status)}">${r.status}</span></td>
                    <td class="py-3 px-4">
                        <button onclick="event.stopPropagation(); editRecord('${r.id}')" class="text-green-600 p-1"><i class="fas fa-edit"></i></button>
                        <button onclick="event.stopPropagation(); deleteRecordConfirm('${r.id}')" class="text-red-600 p-1"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`).join('');
        updatePagination();
        updateRecordCount();
    }

    function getStatusClass(status) {
        return { 'Tepat Waktu': 'status-tepat-waktu', 'Terlambat': 'status-terlambat', 'Pulang Cepat': 'status-pulang-cepat', 'Overtime': 'status-overtime' }[status] || 'status-tidak-hadir';
    }
    
    function updatePagination() {
        const totalPages = Math.ceil(filteredData.length / itemsPerPage);
        const pageNumbers = document.getElementById('pageNumbers');
        pageNumbers.innerHTML = '';
        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, currentPage + 2);
        for (let i = startPage; i <= endPage; i++) {
            const button = document.createElement('button');
            button.textContent = i;
            button.className = `px-3 py-2 border rounded-lg ${i === currentPage ? 'bg-indigo-600 text-white' : 'hover:bg-gray-50'}`;
            button.onclick = () => goToPage(i);
            pageNumbers.appendChild(button);
        }
        document.getElementById('firstBtn').disabled = currentPage === 1;
        document.getElementById('prevBtn').disabled = currentPage === 1;
        document.getElementById('nextBtn').disabled = currentPage === totalPages || totalPages === 0;
        document.getElementById('lastBtn').disabled = currentPage === totalPages || totalPages === 0;
    }

    function updateRecordCount() {
        const start = filteredData.length > 0 ? (currentPage - 1) * itemsPerPage + 1 : 0;
        const end = Math.min(start + itemsPerPage - 1, filteredData.length);
        document.getElementById('totalRecords').textContent = filteredData.length;
        document.getElementById('showingStart').textContent = start;
        document.getElementById('showingEnd').textContent = end;
        document.getElementById('totalData').textContent = filteredData.length;
    }
    
    function goToPage(page) { currentPage = page === 'last' ? Math.ceil(filteredData.length / itemsPerPage) : page; renderTable(); }
    function previousPage() { if (currentPage > 1) { currentPage--; renderTable(); } }
    function nextPage() { if (currentPage < Math.ceil(filteredData.length / itemsPerPage)) { currentPage++; renderTable(); } }
    function sortTable(column) {
        sortDirection = (sortColumn === column && sortDirection === 'asc') ? 'desc' : 'asc';
        sortColumn = column;
        filteredData.sort((a, b) => {
            let aVal = a[column] || '', bVal = b[column] || '';
            if (column === 'tanggal') { aVal = new Date(aVal); bVal = new Date(bVal); }
            if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
            if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
            return 0;
        });
        renderTable();
    }
    function changeItemsPerPage() { itemsPerPage = parseInt(document.getElementById('itemsPerPageSelect').value); currentPage = 1; renderTable(); }
    function toggleSelectAll() { document.querySelectorAll('tbody input[type="checkbox"]').forEach(cb => cb.checked = document.getElementById('selectAll').checked); updateSelectedRecords(); }
    function updateSelectedRecords() { selectedRecords = Array.from(document.querySelectorAll('tbody input[type="checkbox"]:checked')).map(cb => cb.value); }

    // =================================================================
    // CLOCK IN/OUT MODAL LOGIC
    // =================================================================
    function openClockInModal() {
        if (!currentUser) return;
        resetClockInForm(); // Reset first to clear previous state
        
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('clockInDate').value = today;
        document.getElementById('clockInName').value = currentUser.name;
        document.getElementById('clockInEmail').value = currentUser.email;
        document.getElementById('clockInDivision').value = currentUser.division;
        document.getElementById('clockInPosition').value = currentUser.position;
        document.getElementById('clockInTime').value = new Date().toLocaleTimeString('id-ID', { hour12: false, hour: '2-digit', minute: '2-digit' });
        
        updateClockInStatus(new Date());
        document.getElementById('clockInModal').classList.remove('hidden');
    }

    function openClockOutModal() {
        if (!currentUser) return;
        const today = new Date().toISOString().split('T')[0];
        const activeRecords = allAttendanceData.filter(r => r.nama === currentUser.name && r.tanggal === today && r.statusAbsen === 'On Working');
        if (activeRecords.length === 0) {
            alert('âš ï¸ Anda belum melakukan absen masuk atau sudah pulang!');
            return;
        }
        todayClockInRecord = activeRecords[activeRecords.length - 1];
        resetClockOutForm(); // Reset first
        
        document.getElementById('clockOutTime').value = new Date().toLocaleTimeString('id-ID', { hour12: false, hour: '2-digit', minute: '2-digit' });
        updateClockOutStatus(new Date());
        calculateTotalWorkTime(todayClockInRecord.jamMasuk, new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', hour12: false }));
        document.getElementById('clockOutModal').classList.remove('hidden');
    }

    function closeClockInModal() { document.getElementById('clockInModal').classList.add('hidden'); stopCamera(); }
    function closeClockOutModal() { document.getElementById('clockOutModal').classList.add('hidden'); }

    function resetClockInForm() {
        document.getElementById('clockInForm').reset();
        clockInPhotoData = null;
        document.getElementById('cameraButton').classList.remove('hidden');
        document.getElementById('cameraPreview').classList.add('hidden');
        document.getElementById('photoResult').classList.add('hidden');
        document.getElementById('clockInRadiusStatus').classList.add('hidden');
        document.getElementById('clockInOutsideReason').classList.add('hidden');
        document.getElementById('clockInReasonText').required = false; 
    }

    function resetClockOutForm() {
        document.getElementById('clockOutForm').reset();
        workPhotoData = null;
        document.getElementById('workPhotoButton').classList.remove('hidden');
        document.getElementById('workPhotoResult').classList.add('hidden');
        document.getElementById('clockOutRadiusStatus').classList.add('hidden');
        document.getElementById('clockOutOutsideReason').classList.add('hidden');
        document.getElementById('clockOutReasonText').required = false;
    }

    function updateClockInStatus(now) {
        const isLate = now.getHours() * 60 + now.getMinutes() > 9 * 60;
        const msgEl = document.getElementById('clockInStatusMessage');
        const titleEl = document.getElementById('clockInStatusTitle');
        const lateReasonEl = document.getElementById('clockInLateReason');
        msgEl.className = `p-4 rounded-lg ${isLate ? 'bg-red-50 border-red-200' : 'bg-green-50 border-green-200'}`;
        titleEl.textContent = isLate ? 'Anda Terlambat Absen' : 'Absen Tepat Waktu';
        lateReasonEl.classList.toggle('hidden', !isLate);
        document.getElementById('clockInLateReasonText').required = isLate;
    }

    function updateClockOutStatus(now) {
        const totalMinutes = now.getHours() * 60 + now.getMinutes();
        const isEarly = totalMinutes < 17 * 60;
        const isOvertime = totalMinutes > 17 * 60 + 30;
        let statusClass = 'bg-green-50 border-green-200';
        let statusTitle = 'Anda Pulang Tepat Waktu';
        if (isEarly) { statusClass = 'bg-yellow-50 border-yellow-200'; statusTitle = 'Anda Pulang Sebelum Waktunya'; }
        if (isOvertime) { statusClass = 'bg-blue-50 border-blue-200'; statusTitle = 'Waktu Kerja Melebihi'; }
        document.getElementById('clockOutStatusMessage').className = `p-4 rounded-lg ${statusClass}`;
        document.getElementById('clockOutStatusTitle').textContent = statusTitle;
        document.getElementById('clockOutOvertime').classList.toggle('hidden', !isOvertime);
        if (isOvertime) document.getElementById('clockOutOvertimeText').textContent = calculateOvertime(now.toTimeString().slice(0, 5));
    }
    
    function calculateTotalWorkTime(clockInTime, clockOutTime) {
        document.getElementById('clockOutTotalWorkText').textContent = calculateWorkHours(clockInTime, clockOutTime);
    }
    
    // =================================================================
    // HARDWARE INTERACTION (CAMERA, LOCATION)
    // =================================================================
    function startCamera() {
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                currentStream = stream;
                document.getElementById('clockInVideo').srcObject = stream;
                document.getElementById('cameraButton').classList.add('hidden');
                document.getElementById('cameraPreview').classList.remove('hidden');
            }).catch(err => alert('âŒ Gagal mengakses kamera: ' + err));
    }

    function captureClockInPhoto() {
        const video = document.getElementById('clockInVideo');
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        clockInPhotoData = canvas.toDataURL('image/jpeg');
        document.getElementById('clockInPhotoPreview').src = clockInPhotoData;
        document.getElementById('cameraPreview').classList.add('hidden');
        document.getElementById('photoResult').classList.remove('hidden');
        stopCamera();
    }

    function retakeClockInPhoto() {
        clockInPhotoData = null;
        document.getElementById('photoResult').classList.add('hidden');
        startCamera();
    }

    function stopCamera() {
        if (currentStream) currentStream.getTracks().forEach(track => track.stop());
    }

    function handleWorkPhotoSelect(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = e => {
                workPhotoData = e.target.result;
                document.getElementById('clockOutWorkPhotoPreview').src = workPhotoData;
                document.getElementById('workPhotoButton').classList.add('hidden');
                document.getElementById('workPhotoResult').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }
    }

    function retakeWorkPhoto() {
        workPhotoData = null;
        document.getElementById('workPhotoResult').classList.add('hidden');
        document.getElementById('workPhotoButton').classList.remove('hidden');
        document.getElementById('workPhotoInput').value = '';
    }

    function getCurrentLocation(type) {
        navigator.geolocation.getCurrentPosition(
            pos => {
                const { latitude: lat, longitude: lng } = pos.coords;
                document.getElementById(`${type}Latitude`).value = lat.toFixed(6);
                document.getElementById(`${type}Longitude`).value = lng.toFixed(6);
                checkRadius(type, lat, lng);
            },
            err => alert('âŒ Gagal mendapatkan lokasi: ' + err.message)
        );
    }

    function checkRadius(type, userLat, userLng) {
        let isWithinRadius = false;
        let minDistance = Infinity;
        let nearestOffice = null;

        officeCoordinates.forEach((office, index) => {
            const distance = calculateDistance(userLat, userLng, office.lat, office.lng);
            if (distance < minDistance) {
                minDistance = distance;
                nearestOffice = index + 1;
            }
            if (distance <= radiusLimit) {
                isWithinRadius = true;
            }
        });

        const statusEl = document.getElementById(`${type}RadiusStatus`);
        const titleEl = document.getElementById(`${type}RadiusTitle`);
        const messageEl = document.getElementById(`${type}RadiusMessage`);
        const reasonContainerEl = document.getElementById(`${type}OutsideReason`);
        const reasonTextEl = document.getElementById(`${type}ReasonText`);

        if (!statusEl || !titleEl || !messageEl || !reasonContainerEl || !reasonTextEl) {
            console.error("One or more modal elements not found for type:", type);
            return;
        }

        statusEl.classList.remove('hidden');
        messageEl.textContent = `Jarak Anda ${Math.round(minDistance)}m dari kantor terdekat.`;

        if (isWithinRadius) {
            statusEl.className = 'p-4 rounded-lg bg-green-50 border-green-200';
            titleEl.textContent = 'Dalam Radius Kantor';
            reasonContainerEl.classList.add('hidden');
            reasonTextEl.required = false;
        } else {
            statusEl.className = 'p-4 rounded-lg bg-red-50 border-red-200';
            titleEl.textContent = 'Di Luar Radius Kantor';
            reasonContainerEl.classList.remove('hidden');
            reasonTextEl.required = true;
        }
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3;
        const Ï†1 = lat1 * Math.PI/180, Ï†2 = lat2 * Math.PI/180;
        const Î”Ï† = (lat2-lat1) * Math.PI/180, Î”Î» = (lon2-lon1) * Math.PI/180;
        const a = Math.sin(Î”Ï†/2)**2 + Math.cos(Ï†1) * Math.cos(Ï†2) * Math.sin(Î”Î»/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }
    
    // =================================================================
    // FORM SUBMISSION
    // =================================================================
    document.getElementById('clockInForm').addEventListener('submit', function(e) {
        e.preventDefault();
        if (!clockInPhotoData || !document.getElementById('clockInLatitude').value) {
            alert('âŒ Foto dan Lokasi masuk wajib diisi!');
            return;
        }
        const now = new Date();
        const today = now.toISOString().split('T')[0];
        const timeStr = now.toTimeString().slice(0, 5);
        const newRecord = {
            id: `rec-${Date.now()}`,
            nama: currentUser.name, email: currentUser.email, divisi: currentUser.division, posisi: currentUser.position,
            tanggal: today, jamMasuk: timeStr, jamPulang: null, totalKerja: '0j 0m',
            status: getAttendanceStatus(timeStr, null),
            dutyas: document.getElementById('clockInDutyAs').value,
            typeOfWork: document.getElementById('clockInTypeOfWork').value,
            keterangan: document.getElementById('clockInLateReasonText').value || document.getElementById('clockInReasonText').value || '',
            createdAt: new Date().toISOString(), updatedAt: new Date().toISOString(),
            statusAbsen: 'On Working'
        };
        allAttendanceData.unshift(newRecord);
        updateUserUI();
        refreshAdminDashboard();
        closeClockInModal();
        alert(`âœ… Berhasil absen masuk!`);
    });

    document.getElementById('clockOutForm').addEventListener('submit', function(e) {
        e.preventDefault();
        if (!workPhotoData || !document.getElementById('clockOutLatitude').value) {
            alert('âŒ Foto pekerjaan dan Lokasi pulang wajib diisi!');
            return;
        }
        const now = new Date();
        const timeStr = now.toTimeString().slice(0, 5);
        todayClockInRecord.jamPulang = timeStr;
        todayClockInRecord.totalKerja = calculateWorkHours(todayClockInRecord.jamMasuk, timeStr);
        todayClockInRecord.status = getAttendanceStatus(todayClockInRecord.jamMasuk, timeStr);
        todayClockInRecord.overtime = calculateOvertime(timeStr);
        todayClockInRecord.statusAbsen = 'Pulang';
        todayClockInRecord.updatedAt = new Date().toISOString();
        
        updateUserUI();
        refreshAdminDashboard();
        closeClockOutModal();
        alert(`âœ… Berhasil absen pulang!`);
    });

    // =================================================================
    // DATA MANIPULATION & MODALS (Admin & User)
    // =================================================================
    function saveChanges() {
        if (!currentEditingRecord) return;
        const index = allAttendanceData.findIndex(r => r.id === currentEditingRecord.id);
        if (index !== -1) allAttendanceData[index] = { ...currentEditingRecord, updatedAt: new Date().toISOString() };
        else allAttendanceData.unshift({ ...currentEditingRecord, id: `rec-${Date.now()}`, createdAt: new Date().toISOString() });
        refreshAdminDashboard();
        closeDetailModal();
        alert('âœ… Perubahan berhasil disimpan!');
    }

    function deleteRecordConfirm(recordId) {
        if (confirm('âš ï¸ Yakin ingin menghapus data ini?')) {
            allAttendanceData = allAttendanceData.filter(r => r.id !== recordId);
            refreshAdminDashboard();
            alert('âœ… Data berhasil dihapus!');
        }
    }
    
    function viewDetail(recordId) {
        const isNew = recordId.startsWith('new-');
        const record = isNew ? { id: recordId, nama: '', email: '', divisi: '', posisi: '', tanggal: new Date().toISOString().split('T')[0], jamMasuk: '', jamPulang: '' } : allAttendanceData.find(r => r.id === recordId);

        if (!record) return;
        currentEditingRecord = { ...record };
        const detailContent = document.getElementById('detailContent');
        detailContent.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                    <select class="editable-field w-full" onchange="autoFillEmployeeData(this.value)">
                        <option value="">Pilih Karyawan</option>
                        ${Object.keys(employeeData).sort().map(name => `<option value="${name}" ${record.nama === name ? 'selected' : ''}>${name}</option>`).join('')}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" class="editable-field w-full" value="${record.email || ''}" onchange="updateField('email', this.value)">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Divisi</label>
                    <input type="text" class="editable-field w-full" value="${record.divisi || ''}" onchange="updateField('divisi', this.value)">
                </div>
                 <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Posisi</label>
                    <input type="text" class="editable-field w-full" value="${record.posisi || ''}" onchange="updateField('posisi', this.value)">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
                    <input type="date" class="editable-field w-full" value="${record.tanggal}" onchange="updateField('tanggal', this.value)">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Jam Masuk</label>
                    <input type="time" class="editable-field w-full" value="${record.jamMasuk || ''}" onchange="updateField('jamMasuk', this.value)">
                </div>
                 <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Jam Pulang</label>
                    <input type="time" class="editable-field w-full" value="${record.jamPulang || ''}" onchange="updateField('jamPulang', this.value)">
                </div>
            </div>`;
        document.getElementById('detailModal').classList.remove('hidden');
    }

    function viewUserAttendanceDetail(recordId) {
        const record = allAttendanceData.find(r => r.id === recordId);
        if (!record) {
            alert('Data absensi tidak ditemukan.');
            return;
        }

        const detailContent = document.getElementById('userAttendanceDetailContent');
        detailContent.innerHTML = `
            <div class="grid grid-cols-2 gap-x-6 gap-y-3 text-sm">
                <div class="font-semibold text-gray-500">Tanggal</div>
                <div class="text-gray-800">${formatDate(record.tanggal)}</div>

                <div class="font-semibold text-gray-500">Jam Masuk</div>
                <div class="text-gray-800 font-mono">${record.jamMasuk}</div>

                <div class="font-semibold text-gray-500">Jam Pulang</div>
                <div class="text-gray-800 font-mono">${record.jamPulang || 'Belum Clock Out'}</div>

                <div class="font-semibold text-gray-500">Total Kerja</div>
                <div class="text-gray-800 font-semibold">${record.totalKerja}</div>

                <div class="font-semibold text-gray-500">Status</div>
                <div><span class="status-badge ${getStatusClass(record.status)}">${record.status}</span></div>

                <div class="col-span-2 border-t mt-2 pt-3"></div>

                <div class="font-semibold text-gray-500">Bertugas Sebagai</div>
                <div class="text-gray-800">${record.dutyas}</div>

                <div class="font-semibold text-gray-500">Jenis Pekerjaan</div>
                <div class="text-gray-800">${record.typeOfWork}</div>

                <div class="col-span-2 font-semibold text-gray-500 mt-2">Keterangan</div>
                <div class="col-span-2 text-gray-800 bg-gray-50 p-2 rounded-md">${record.keterangan || 'Tidak ada keterangan.'}</div>
            </div>
        `;

        document.getElementById('userAttendanceDetailModal').classList.remove('hidden');
    }

    function closeUserAttendanceDetailModal() {
        document.getElementById('userAttendanceDetailModal').classList.add('hidden');
    }

    function autoFillEmployeeData(selectedName) {
        if (currentEditingRecord && selectedName && employeeData[selectedName]) {
            const employee = employeeData[selectedName];
            currentEditingRecord.nama = selectedName;
            currentEditingRecord.email = employee.email;
            currentEditingRecord.divisi = employee.division;
            currentEditingRecord.posisi = employee.position;
            // Re-render modal with new data by faking a viewDetail call on the same (potentially new) ID
            viewDetail(currentEditingRecord.id); 
        }
    }

    function updateField(field, value) {
        if (currentEditingRecord) {
            currentEditingRecord[field] = value;
        }
    }
    
    function openAddNewsModal() {
        document.getElementById('addNewsModal').classList.remove('hidden');
    }

    function closeAddNewsModal() {
        document.getElementById('addNewsModal').classList.add('hidden');
        document.getElementById('addNewsForm').reset();
        document.getElementById('newsImagePreview').classList.add('hidden');
        newsPhotoData = null;
    }

    function previewNewsImage(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                newsPhotoData = e.target.result;
                const preview = document.getElementById('newsImagePreview');
                preview.src = newsPhotoData;
                preview.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }
    }

    function handleAddNews(e) {
        e.preventDefault();
        const newNews = {
            id: Date.now(),
            title: document.getElementById('newsTitle').value,
            content: document.getElementById('newsContent').value,
            date: new Date().toISOString().split('T')[0],
            category: document.getElementById('newsCategory').value,
            priority: document.getElementById('newsPriority').value,
            author: currentUser.name,
            photo: newsPhotoData
        };
        companyNews.unshift(newNews);
        refreshUserDashboardNews();
        closeAddNewsModal();
        alert('âœ… Berita berhasil ditambahkan!');
    }
    
    function refreshUserDashboardNews() {
        if (userType === 'user' && !document.getElementById('userDashboard').classList.contains('hidden')) {
             renderCompanyNews();
        }
    }

    function editRecord(recordId) { viewDetail(recordId); }
    function addNewRecord() { viewDetail(`new-${Date.now()}`); }
    function bulkActions() { alert('Fungsi aksi massal belum diimplementasikan sepenuhnya.'); }
    function exportData() { alert('Fungsi ekspor belum diimplementasikan sepenuhnya.'); }
    function closeDetailModal() { document.getElementById('detailModal').classList.add('hidden'); currentEditingRecord = null; }
    function deleteRecord() { if(currentEditingRecord) deleteRecordConfirm(currentEditingRecord.id); closeDetailModal(); }
    function viewAllNews() { alert('Fitur ini belum tersedia.'); }
    function viewAllAttendance() { alert('Fitur ini belum tersedia.'); }
    
    </script>
</body>
</html>
